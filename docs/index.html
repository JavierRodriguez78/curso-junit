<!DOCTYPE html>
<html>
  <head>
    <title>GeeksHubsAcademy.com - Curso de JUnit, Jacoco y Mockito</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      /* Two-column layout */
    .left-column {
      color: #777;
      width: 20%;
      height: 92%;
      float: left;
    }
      .left-column h2:last-of-type, .left-column h3:last-child {
        color: #000;
      }
    .right-column {
      width: 75%;
      float: right;
      padding-top: 1em;
    }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Curso de JUnit, Jacoco y Mockito

---
# Contenido: Resumen

0. Testing
1. JUnit
2. Jacoco
3. Mockito
4. TDD
5. Reto

---
# Testing
  1. Qué es Software Testing?
    1. Modelo: SUT, Parametros, Dependencias
    2. ¿Quién prueba que el test es correcto?
  2. Caja negra, caja blanca
      - PROs y CONs
      - Caja blanca + Mocks
      - Falacias de caja blanca
  3. Granularidad: Unitarios, Integración, Aceptación
  4. Test vs Code

---
# JUnit
  0. JUnit 4 vs JUnit 5
  0. @Anotaciones de la A a la Z
  1. Test: Hola Mundo
  2. @Test, @Before, ...
  3. Assertions
    0. Fail fast vs. Fail last
    1. JUnit
    2. Hamcrest
---
# Jacoco
  1. Qué es cobertura de código y por qué la quiero
  2. Integración continua
  3. Ejecución con Maven
---
# Mockito
  1. Mocks
  2. Spies
---
# TDD
  0. ¿Qué es TDD?
  1. ¿Qué aporta TDD?
  2. Red, green, refactor
---
# Reto: Números primos
  1. La caja mágica
  2. TDD

---

# Qué es un test
# "Código que prueba **_automáticamente_** el correcto funcionamiento de otro código"

---

# Cuestiones filosóficas
![](imgs/philosoraptor.png)
---
![](imgs/watchmen.png)
---

# Ejemplo

# Test en JUnit

```java
public class Test {

  @Test
  public void test() {
    int resultado = suma(1,2);
    assertEquals(3, resultado);
  }

  public int suma(int a, int b) {
    return a+b;
  }
}
```

---

# Estructura de un Test (AAA)

- Arrange (Preparar)
- Act (Probar)
- Assert (Verificar)

```java
public class MiTest {

	@Test
	public void test() {
		// Preparar
		String pattern = "dd/MM/yyyy";
		SimpleDateFormat dateFormat = new SimpleDateFormat(pattern);
		Calendar calendario = Calendar.getInstance();
		calendario.set(2017, 8, 15);

		// Probar
		String fechaConFormato = dateFormat.format(calendario.getTime());

		// Verificar
		assertEquals("15/09/2017", fechaConFormato);
	}

}
```
---
# Demo

# Eclipse + Maven + JUnit

http://www.eclipse.org/

https://maven.apache.org/guides/getting-started/index.html

http://junit.org/junit4/

---
# Maven
`pom.xml`
```xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                      http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>com.geekshubsacademy</groupId>
  <artifactId>curso-junit</artifactId>
  <packaging>jar</packaging>
  <version>1.0.0-SNAPSHOT</version>
  <name>Curso de JUnit</name>
  <url>http://geekshubsacademy.com</url>
  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
  </dependencies>
</project>
```
---
# Eclipse

![](imgs/eclipse-import-maven-project.png)
---
#JUnit
Para ejecutar JUnit desde Eclipse:

Sobre la clase de Test --> click derecho --> Run As --> JUnit

![](imgs/eclipse-run-junit.png)
---
#JUnit
Resultados:
- Rojo: Se ha producido una **excepcion** al ejecutar el código
- Azul: El test no ha satisfecho las expectativas
- Verde: El test ha pasado OK.

![](imgs/eclipse-junit-resultados.png)

---
class: middle, center

# @Anotaciones de JUnit
# Ciclo de Vida de un Test
## @BeforeClass
## @Before
## @Test
## @After
## @AfterClass
### @Ignore

---
# Demo: Ciclo de Vida

```java
public class CicloVidaTest {

	private static String ciclo = "";

	@BeforeClass
	public static void beforeClass() {
		ciclo += "@BeforeClass";
		assertEquals("@BeforeClass", ciclo);
	}

	@Before
	public void before() {
		ciclo += " @Before";
		assertEquals("@BeforeClass @Before", ciclo);
	}

	@Test
	public void test() {
		ciclo += " @Test 1";
		assertEquals("@BeforeClass @Before @Test 1", ciclo);
	}

	@After
	public void after() {
		ciclo += " @After";
		assertEquals("@BeforeClass @Before @Test 1 @After", ciclo);
	}

	@AfterClass
	public static void afterClass() {
		ciclo += " @AfterClass";
		assertEquals("@BeforeClass @Before @Test 1 @After @AfterClass", ciclo);
	}

}
```
---
# Ejercicio:
En el proyecto de Eclipse hay una clase ValidadorEmail.
Sospechamos que funciona mal.
## Objetivo
"Escribe una clase con varios @Test para la clase ValidadorEmail.
 Algunos tests fallarán (azul),
 pero en ningún caso deberían arrojar una Excepción (rojo)."

 Consejo: Usa las anotaciones del ciclo de vida.
---
# JaCoCo
https://github.com/jacoco/jacoco

Configuración en Maven:
```xml
<plugin>
				<groupId>org.jacoco</groupId>
				<artifactId>jacoco-maven-plugin</artifactId>
				<version>${jacoco.version}</version>
				<executions>
					<execution>
						<id>prepare-agent</id>
						<goals>
							<goal>prepare-agent</goal>
						</goals>
					</execution>
					<execution>
						<id>report</id>
						<phase>prepare-package</phase>
						<goals>
							<goal>report</goal>
						</goals>
					</execution>
					<execution>
						<id>post-unit-test</id>
						<phase>test</phase>
						<goals>
							<goal>report</goal>
						</goals>
						<configuration>
							<!-- Sets the path to the file which contains the execution data. -->

							<dataFile>target/jacoco.exec</dataFile>
							<!-- Sets the output directory for the code coverage report. -->
							<outputDirectory>target/jacoco-ut</outputDirectory>
						</configuration>
					</execution>
				</executions>
				<configuration>
					<systemPropertyVariables>
						<jacoco-agent.destfile>target/jacoco.exec</jacoco-agent.destfile>
					</systemPropertyVariables>
				</configuration>
			</plugin>
```
---
# JaCoCo

Ejecución con maven:
```
mvn test
```
Ejecución con Eclipse (a través de Maven):
```
Sobre el proyecto --> botón derecho --> Run As --> maven test
```
Informes de Cobertura:
```
target/jacoco-ut/index.html
```
**NOTA**: JaCoCo sólo genera los informes si todos los tests pasan OK.
---
# Cobertura

Se refiere a las líneas de código que han sido ejecutadas
como resultado de pasar los tests.

---
# Demo: Cobertura
```java
public class Direccion {

	private String direccion;

	public Direccion(String direccion) {
		this.direccion = direccion;
	}

	public String getCodigoPostal() {
		Pattern pattern = Pattern.compile("[0-9]{5}");
		Matcher matcher = pattern.matcher(this.direccion);
		if (matcher.find()) {
			return matcher.group();
		}
		return null;
	}

}
```

---
# Demo: Cobertura
```java
public class CoberturaTest {

	@Test
	public void obtenerCodigoPostal() {
		Direccion direccion = new Direccion("Calle Vicente Barrera Cambra 6 bajo (46020)");
		String codigoPostal = direccion.getCodigoPostal();
		assertEquals("46020", codigoPostal);
	}

	@Test
	public void noHayCodigoPostal() {
		Direccion direccion = new Direccion("Calle Vicente Barrera Cambra 6 bajo");
		String codigoPostal = direccion.getCodigoPostal();
		assertNull(codigoPostal);
	}

}
```
---
# JaCoco
Informe de cobertura de la clase Direccion:

![](imgs/jacoco-cien-por-cien.png)
---
# Cuestiones filosóficas II
![](imgs/philosoraptor-2.jpg)


---
# Contraejemplo:

## 100% cobertura != código libre de fallos

```java
public class Calculadora {

	public static int dividir(int a, int b) {
		return a / b;
	}

}

public class CienPorCienCoberturaConErroresTest {

	@Test
	public void esteTestCubreElCienPorCienDeLaClaseCalculadora() {
		assertEquals(2, Calculadora.dividir(4, 2));
	}

	@Test
	public void sinEmbargoEsteTestLanzaArithmeticExceptionAlDividirPorCero() {
		assertEquals(2, Calculadora.dividir(4, 0));
	}
}
```
---
# Cuestiones Filosóficas III

![](imgs/philosoraptor-3.jpg)
---
# Motivos frecuentes para no testear

1. A veces es complicado testear el código existente
2. Tengo prisa por entregar/corregir este bug y no puedo perder tiempo testeando
3. Mantener los tests lleva mucho tiempo y esfuerzo

---
# Complicaciones técnicas para testear

- Fabricación de datos de pruebas
- Creación de objetos para inyectar dependencias/pasar por parámetro
- Instanciación del objeto a testear
- Verificación de los resultados

---
# Soluciones técnicas para testear

- Fabricación de datos de pruebas --> [Estamos solos]
- Creación de objetos para inyectar/pasar por parámetro --> **[Mockito]**
- Instanciación del objeto a testear --> [Spring Framework]
- Verificación de los resultados --> [Hamcrest]

---
# Mockito

http://site.mockito.org/

"Mockito es una librería para instanciar objetos
a partir de tipos (clases/interfaces)
y programar respuestas concretas
cuando se llama a los métodos del objeto instanciado"
`pom.xml`
```xml
<dependency>
  <groupId>org.mockito</groupId>
  <artifactId>mockito-core</artifactId>
  <version>4.12</version>
  <scope>test</scope>
</dependency>
```
---
# Mockito: Ejemplo
## Login con Certificado digital
```java
public class LoginController {

	private Connection connection;

	public LoginController(Connection connection) {
		this.connection = connection;
	}

	public boolean login(X509Certificate certificado) {
		boolean resultado = false;
		PreparedStatement prepareStatement = null;
		ResultSet resultSet = null;

			Principal subjectDN = certificado.getSubjectDN();
			prepareStatement = connection.prepareStatement("SELECT count(*) FROM usuarios where login = ?");
			prepareStatement.setString(1, subjectDN.getName());
			resultSet = prepareStatement.executeQuery();
			if (resultSet.next()) {
				resultado = resultSet.getInt(1) > 0;
			}
    return resultado;
}
```
---
# Ejemplo: Test sin Mockito
- Tendría que tener un fichero con un Certificado de pruebas
- Tendría que tener una BDD corriendo para obtener una Conexión
```java
@Test
public void testLoginConCertificado() throws CertificateException {
  // Preparar
  byte[] certData = new byte[0];
  X509Certificate certificado = X509Certificate.getInstance(certData);
  Connection connection = null;

  // Probar
  LoginController controller = new LoginController(connection);
  boolean login = controller.login(certificado);

  // Verificar
  assertTrue(login);
}
```
- No tengo ninguna, en este caso fallaría el test

---
# Ejemplo: Test con Mockito
- No necesito un fichero con un Certificado ni una BDD con datos de prueba
- Mockito le dice a los objetos qué valores tienen que devolver

```java
@Test
public void testLoginConCertificado() throws CertificateException, SQLException {
  // Preparar
  X509Certificate certificado = mock(X509Certificate.class);
  Connection connection = mock(Connection.class);

  // Programar respuestas
  Principal principal = mock(Principal.class);
  when(certificado.getSubjectDN()).thenReturn(principal);
  when(principal.getName()).thenReturn("usuario");

  PreparedStatement preparedStatement = mock(PreparedStatement.class);
  when(connection.prepareStatement(anyString())).thenReturn(preparedStatement);
  ResultSet resultSet = mock(ResultSet.class);
  when(preparedStatement.executeQuery()).thenReturn(resultSet);
  when(resultSet.next()).thenReturn(true);
  when(resultSet.getInt(1)).thenReturn(1);

  // Probar
  LoginController controller = new LoginController(connection);
  boolean login = controller.login(certificado);

  // Verificar
  assertTrue(login);
}
```
---
# Cuestiones Filosóficas IV
¿Y si directamente _mockeo_ la clase LoginController?
Este test pasa Ok!
```java
@Test
public void testSinSentido() throws CertificateException {
  // Probar
  LoginController controller = mock(LoginController.class);
  when(controller.login(null)).thenReturn(true);
  boolean login = controller.login(null);

  // Verificar
  assertTrue(login);
}

```
---
# Caja blanca vs caja negra
![](imgs/caja-blanca-caja-negra.png)
---
# Caja blanca vs caja negra
- Los test de caja blanca tienen la desventaja de necesitar conocer
los detalles de la implementación del código que prueban.
- Esto implica directamente que al cambiar la implementación,
el test romperá.
- Es por ello que se habla de "fragilidad" de los tests de caja blanca.
- Test frágiles === Mucho mantenimiento
---
# Propiedades deseables en una suite de pruebas
## Siglas en inglés: FIRST
- **F**ast: Que pasen rápido, muy rápido.
- **I**solation: Que unos tests no impacten en otros.
- **R**epeatable: Que un test no falle si lo paso más de una vez (bajo las mismas condiciones).
- **T**imely: Que estén escritos antes de que sea demasiado tarde.
---
# Hamcrest

---
TODO:
- JUnit 4 vs 5
- @Anotaciones avanzadas de JUnit

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
